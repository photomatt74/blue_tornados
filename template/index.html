<!DOCTYPE html>
<html>

<head>
    <meta charset=utf-8 />
    <title>Draft</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
        crossorigin="" />
    <link href='http://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>

    <style>
        body {
            margin: 0;
            padding: 0;
            background: whitesmoke;
            font-family: Lato, sans-serif;
            color: #0D0000;
        }

        header,
        footer,
        section {
            padding: 6px 10%;
            margin: 0 auto;
            width: 80%
        }

        h1 {
            display: inline-block;
            margin-right: 20px;
            color: #001323;
        }

        h2 {
            display: inline-block;
            color: #001323;
        }

        #map {
            width: 80%;
            height: 740px;
            margin: 10px 10%;
            background: rgb(54, 53, 53);
            border: 2px solid #dddedf;
        }

        a {
            color: #004A8B;
        }

        a:hover {
            color: rgb(67, 69, 71);
            text-decoration: none;
        }

        p {
            font-size: 1em;
            color: #001323;
        }

        .legend {
            padding: 6px 8px;
            font-size: 1em;
            /* Use transparency to blend elements. */
            border: 2px solid rgba(145, 168, 153, 0.2);
            background: rgba(233, 232, 232, 0.9);
            color: rgba(0, 0, 0, 0.8);
            border-radius: 5px;
        }

        .legend h3 {
            font-size: 1.3em;
            font-weight: bolder;
            color: rgb(4, 4, 4);
            /* Light */
            margin: 0 0 10px 0;
        }

        .legend span {
            width: 20px;
            height: 20px;
            float: left;
            margin: 0 10px 4px 0;
        }

        .legend label {
            font-size: 1em;
        }

        .legend label:after {
            content: ' ';
            display: block;
            clear: both;
        }

        .leaflet-bar a {
            /* Override the default style for Leaflet's zoom  */
            background: rgba(100, 100, 100, 0.9);
            color: rgba(244, 244, 244, 0.8);
        }

        footer {
            padding: 6px 10%;
            width: 80%;
        }

        p {
            font-size: 1em;
            color: #001323;
        }
    </style>
</head>

<body>
    <header>
        <h1>Kentucky Tornados:</h1>
        <h2>It's Weird Weather</h2>
    </header>

    <div id='map'></div>
    <footer>
        <p>Map authored by Matt Barton</p>
        <p>Are we having more tornados in Kentucky? This map will show tornados in Kentucky by location and decade.
        </p>
    </footer>

    <!-- Load scripts using Subresource Integrity (SRI) is a security feature 
      that enables browsers to verify that resources they fetch (from a CDN) 
      are delivered without unexpected manipulation. -->
      <script src="https://code.jquery.com/jquery-3.6.0.min.js"
      integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
      integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
      crossorigin=""></script>
    <script src='https://unpkg.com/simple-statistics@7.6.0/dist/simple-statistics.min.js'>
    </script>
    <script src="data/ky_tornados_1961_2021.js">
    </script>

    <script>
        var map = L.map('map', {
            center: [37.8, -85.8], // centered in Kentucky
            zoom: 8
        });

        var tiles = L.tileLayer(
            'https://cartodb-basemaps-{s}.global.ssl.fastly.net/rastertiles/dark_all/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
                subdomains: 'abcd',
                maxZoom: 19
            });
        tiles.addTo(map);

        // commonStyles 
        var commonStyles = {
            stroke: true,
            fill: true,
            fillOpacity: .8,
            radius: 2000,
            color: '#1F78B4'
        }; // styles closed

        var hotStyles = {
            stroke: true,
            fill: true,
            fillOpacity: 1,
            radius: 2000,
            color: '#cf2525'
        }; // styles closed

        // Global vars

        var decade = {
            first20Layer: {
                start_date: "01/01/1961",
                end_date: "12/31/1980",
                color: '#cf2525',
            },
            second20Layer: {
                start_date: "01/01/1981",
                end_date: "12/31/2000",
                color: '#e6e'
            },
            third20Layer: {
                start_date: "01/01/2001",
                end_date: "12/31/2021",
                color: '#e6e22c'
            },
        }; // decade closed

        var markLayers = {};

 
        
    //   geoJsonLayers[layer] = L.geoJson(tornados, {
    //     // coordsToLatLng: function (cords) {
    //     //     return new L.LatLng(layer.BEGIN_LAT,layer.BEGIN_LON);
    //     //     console.log(latlng);
    //     // },
    //     eachLayer: function (layer) {
    //         latlng = [BEGIN_LAT,BEGIN_LON];
    //     },
    //     pointToLayer: function (feature, latlng) {
    //       return L.circle(latlng, commonStyles);
    //     },
    //     filter: function (feature) {
    //       if ((decade[layer].start_date >= tornados.BEGIN_DATE) && (decade[layer].start_date <= tornadoes.END_DATE)) {
    //         return feature;
    //       }
    //     },
    //     style: function (feature) {
    //       return {
    //         color: decade[layer].color,
    //         radius: 20
    //       }
    //     }
    //   }).addTo(map);
    // } // for loop closed

            //  Create empty layer group
            let tornadoGroup = L.layerGroup();

            //  Loop through the data and create a line for each valid feature
            for (let t of tornados) {

                // Load coordinates and convert them to numbers with + operator
                const cords = [
                    +t.BEGIN_LAT, +t.BEGIN_LON
                ]
                var start_date = t.BEGIN_DATE
                var tip = `<b>${t.EVENT_TYPE}<br>${start_date}`;

                // Test all values to see if they are valid
                const check = cords.every(cord => {

                    // Returns true if all values are valid
                    return typeof (cord) === 'number' && !isNaN(cord) && cord !== 0;
                })
                // If true, build the tornado groupline and add it to the layergroup
                if (check) {
                    const mark = L.circle([cords[0], cords[1]], commonStyles).bindTooltip(tip)
                
                    // Create functions to draw legend, add interactivity, etc. because you have access to properties here

                    const torDecade = start_date.slice(6,);
                    
                    for (let d in decade) {
                        const x = decade[d].start_date.slice(6,);
                        const y = decade[d].end_date.slice(6,);
                        
                        if (torDecade >= x && torDecade <= y) {

                            mark.setStyle({
                                color: decade[d].color
                            });

                        }
                    }

                    tornadoGroup.addLayer(mark);
                } // close if 

            } // close for
    
       
            drawMap(tornadoGroup);

        function drawMap(tornadoGroup) {

            tornadoGroup.eachLayer(function (layer) {

                layer.on('mouseover', function () {
                    layer.setStyle(hotStyles);
                });
                layer.on('mouseout', function () {
                    layer.resetStyle();
                });
                // if (L.Browser.mobile) {
                //   // if true use popup
                //   layer.bindPopup(toolTipInfo);
                // } else {
                //   // if false use tooltip
                //   layer.bindTooltip(toolTipInfo, 
                // {sticky: true,
                //   maxHeight: 10,
                //   offset: [15,0] });
                // };

            }); // close each layer
            tornadoGroup.addTo(map);
        }; // close drawMap

        $.getJSON("data/us_states_20m.geojson", function (data) {

          var stateLayer = L.geoJson(data, {
            style: function (feature) {
              return {
                // Let's experiment with these colors shortly
                // color: '#222222', // Gray
                color: '#ffffff', // White
                // Make line weight larger than the county outline
                weight: 2,
                fillOpacity: 0,
                // This property allows us control interactivty of layer
                interactive: false
              };
            },

            // Filter for the correct state to use
            filter: function (feature) {
              if (feature.properties.NAME == "Kentucky") {
                return feature;
              }
            }
          });

          // Add layer to map!
          stateLayer.addTo(map)
        });
   
        // tornadoGroup can now have events added to it


        // var sourcesLabels = {
        //   "1961-1981 Tornados": geoJsonLayers.first20Layer,
        //   "1981-2001 Tornados": geoJsonLayers.second20Layer,
        //   "2001-2021 Tornados": geoJsonLayers.third20Layer,
        // } // labels closed

        // L.control.layers(null, sourcesLabels, {
        //   collapsed: false
        // }).addTo(map);
    </script>

</body>

</html>